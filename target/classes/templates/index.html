<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Catalogo N-migos</title>

    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/index.css">
</head>

<body class="Catalogo">
<div class="navbar">

    <div class="menu-container">
        <input type="checkbox" id="toggle-menu" class="toggle-menu">
        <label for="toggle-menu" class="menu-icon">☰ Menú</label>

        <nav class="menu">
            <ul>
                <li><a href="/">Inicio</a></li>
                <li th:if="${isLoggedIn}"><a href="/perfil">Mi Perfil</a></li>
                <li th:if="${isLoggedIn}"><a href="biblioteca">Mi Biblioteca</a></li>
                <li><a href="#">Noticias</a></li>
            </ul>
        </nav>
    </div>


    <div class="boton-derecha">
        <div class="usuario-menu">
            <button class="btn-icon" onclick="toggleMenu()">
                <i class="fas fa-user"></i>
            </button>

            <div th:unless="${isLoggedIn}" class="submenu-usuario">
                <ul>
                    <li><a href="login">Iniciar sesión</a></li>
                    <li><a href="register">Registrarse</a></li>
                </ul>
            </div>
            <div th:if="${isLoggedIn}" class="submenu-usuario">
                <ul>
                    <li>
                        <a id="logoutButton" href="javascript:void(0)">Cerrar sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </div>
</div>

<div class="anuncio">
    <img src="https://media.ouest-france.fr/v1/pictures/MjAyNDEyM2U0MDUyYTgxYjM0Yjk1YWVhYTNjNDU5NjhjN2ZkYTk?width=630&height=354&focuspoint=50%2C25&cropresize=1&client_id=bpeditorial&sign=5583092a8a71cb18d6439f8fc96267d77f9e7db471df777f4e44b57b70e6a3eb" width="700" height="300" alt="Anuncio" rel="noopener noreferrer">
</div>

<div>
    <section class="juegos">

        <!-- Buscador de juegos -->
        <h3 class="busqueda-container">

            <form id="busquedaForm"  onsubmit="return buscarJuego(event)">
                <input type="text" id="busqueda" placeholder="Buscar juego...">
                <button type="submit" class="submit-button">
                    <i class="fas fa-search"></i>
                </button>
            </form>

            <!-- Botón de filtros -->
            <div class="filtros-container">
                <button id="filtro-genero">Filtrar por Género</button>
                <button id="filtro-puntuacion">Filtrar por Puntuación</button>
            </div>

            <!-- Filtros aplicados -->
            <div id="filtros-aplicados" style="margin-top: 10px;">
                <h4>Filtros aplicados:</h4>
                <p id="lista-filtros">Ninguno</p>
                <button id="borrar-filtros" style="display: none;">Borrar filtros</button>
            </div>


        </h3>

        <!-- Ventana emergente para géneros -->
        <div id="popup-generos" class="popup" style="display: none;">
            <div class="popup-content">
                <h3>Selecciona un Género</h3>
                <ul id="lista-generos">
                    <li th:each="genero : ${generos}" th:text="${genero.nombre}"
                        th:data-nombre="${genero.nombre}"
                        onclick="seleccionarGenero(this)"></li>
                </ul>
                <button id="cerrarPopup" class="cerrarPopup">Aplicar</button>
            </div>
        </div>


        <h2>Juegos Disponibles  </h2>

        <div id="juego-lista" class="juego-lista">
            <!-- Lista generada por Thymeleaf para la carga inicial de juegos -->
            <div class="juego-item" th:each="juego : ${juegos}">
                <img th:src="${juego.imagen}" th:alt="${juego.titulo}" />
                <h3 th:text="${juego.titulo}">Título del Juego</h3>
                <p th:text="'Calificación: ' + ${juego.calificacion}">Calificación</p>
                <a th:href="@{/info(id=${juego.id})}" class="btn-jugar">+info</a>
                <button th:if="${isLoggedIn}" class="btn-biblioteca"
                        th:data-id="${juego.id}"
                        th:data-token="${token}"
                        onclick="addToLibrary(this)">
                    Agregar a mi biblioteca
                </button>
            </div>
        </div>

        <!-- paginacion de juegos -->
        <div id="pagination" class="pagination">
            <button th:if="${paginaActual > 1}"
                    th:onclick="'location.href=\'/?pagina=' + (${paginaActual} - 1) + '\''">
                Anterior
            </button>

            <button th:each="i : ${#numbers.sequence(1, totalPaginas)}"
                    th:classappend="${i == paginaActual} ? 'active' : ''"
                    th:onclick="'location.href=\'/?pagina=' + ${i} + '\''"
                    th:text="${i}">
            </button>


            <button th:if="${paginaActual < totalPaginas}"
                    th:onclick="'location.href=\'/?pagina=' + (${paginaActual} + 1) + '\''">
                Siguiente
            </button>
        </div>

    </section>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const logoutButton = document.getElementById('logoutButton');
        if (logoutButton) {
            logoutButton.addEventListener('click', async () => {
                try {
                    const response = await fetch('/auth/logout', {
                        method: 'POST',
                        credentials: 'include',
                    });
                    if (response.ok) {
                        alert('Sesión cerrada correctamente');
                        window.location.href = '/'; // Redirige al inicio
                    } else {
                        alert('Error al cerrar sesión');
                    }
                } catch (error) {
                    console.error('Error:', error);
                    alert('No se pudo cerrar la sesión');
                }
            });
        }
    });

    async function buscarJuego(event) {
        event.preventDefault(); // Previene el comportamiento por defecto

        const busqueda = document.getElementById('busqueda').value.toLowerCase();
        const juegoLista = document.getElementById('juego-lista');

        try {
            const response = await fetch(`/buscar?titulo=${encodeURIComponent(busqueda)}`);
            if (response.ok) {
                const juegosFiltrados = await response.json();


                // Limpiar la lista actual
                juegoLista.innerHTML = '';

                if (juegosFiltrados.length === 0) {
                    juegoLista.innerHTML = '<p>No se encontraron juegos.</p>';
                    return;
                }

                // Agregar los resultados al DOM
                juegosFiltrados.forEach(juego => {
                    const juegoItem = document.createElement('div');
                    juegoItem.classList.add('juego-item');
                    juegoItem.innerHTML = `
                        <img src="${juego.imagen}" alt="${juego.titulo}">
                        <h3>${juego.titulo}</h3>
                        <p>Calificación: ${juego.calificacion}</p>
                        <a href="/info?id=${juego.id}" class="btn-jugar">+info</a>
                    `;
                    if (juego.isLoggedIn) {
                        const button = document.createElement('button');
                        button.classList.add('btn-biblioteca');
                        button.textContent = 'Agregar a mi biblioteca';
                        button.setAttribute('data-id', juego.id);
                        button.setAttribute('data-token', juego.token);
                        button.onclick = () => addToLibrary(button);
                        juegoItem.appendChild(button);
                    }
                    juegoLista.appendChild(juegoItem);
                });
            } else {
                console.error("Error al buscar juegos:", response.statusText);
            }
        } catch (error) {
            console.error("Error al buscar juegos:", error);
        }
    }

    function mostrarJuegosFiltrados(juegosFiltrados) {
        const juegoLista = document.querySelector('.juego-lista');
        juegoLista.innerHTML = ''; // Limpia la lista actual

        if (juegosFiltrados.length === 0) {
            juegoLista.innerHTML = '<p>No se encontraron juegos.</p>';
            return;
        }

        juegosFiltrados.forEach(juego => {
            const juegoItem = document.createElement('div');
            juegoItem.classList.add('juego-item');
            juegoItem.innerHTML = `
                <img src="${juego.imagen}" alt="${juego.titulo}">
                <h3>${juego.titulo}</h3>
                <p>Calificación: ${juego.calificacion}</p>
                <a href="/info?id=${juego.id}" class="btn-jugar">+info</a>
            `;
            juegoLista.appendChild(juegoItem);
        });
    }
let generosSeleccionados = []; // Lista de géneros seleccionados

// Mostrar ventana emergente de géneros
document.getElementById('filtro-genero').addEventListener('click', async () => {
    const popupGeneros = document.getElementById('popup-generos');
    const listaGeneros = document.getElementById('lista-generos');

    // Cargar los géneros desde el servidor
    try {
        const response = await fetch('/generos');
        if (response.ok) {
            const generos = await response.json();
            listaGeneros.innerHTML = ''; // Limpia la lista de géneros
            generos.forEach(genero => {
                const li = document.createElement('li');
                li.textContent = genero.nombre; // Muestra el nombre del género
                li.style.cursor = 'pointer'; // Cambia el cursor al pasar por encima
                li.addEventListener('click', () => {
                    if (generosSeleccionados.includes(genero.nombre)) {
                        // Si ya está seleccionado, lo eliminamos
                        generosSeleccionados = generosSeleccionados.filter(
                            g => g !== genero.nombre
                        );
                        li.style.backgroundColor = ''; // Restablece el fondo
                    } else {
                        // Si no está seleccionado, lo añadimos
                        generosSeleccionados.push(genero.nombre);
                        li.style.backgroundColor = '#444'; // Resalta la selección
                    }
                    console.log("Géneros seleccionados:", generosSeleccionados);
                    actualizarFiltrosAplicados(); // Actualiza la lista de filtros
                });
                listaGeneros.appendChild(li); // Añade el género a la lista
            });
        } else {
            console.error("Error al cargar los géneros:", response.statusText);
        }
    } catch (error) {
        console.error("Error al cargar los géneros:", error);
    }

    // Mostrar el popup
    popupGeneros.style.display = 'flex';
});

// Cerrar la ventana emergente y aplicar filtros
document.getElementById('cerrarPopup').addEventListener('click', async () => {
    const popupGeneros = document.getElementById('popup-generos');
    popupGeneros.style.display = 'none';

    // Aplicar los filtros
    if (generosSeleccionados.length > 0) {
        try {

            console.log("buscando juegos")
            const response = await fetch(`/filtrar?generos=${encodeURIComponent(generosSeleccionados.join(','))}`);
            if (response.ok) {
                const juegos = await response.json();
                mostrarJuegosFiltrados(juegos); // Actualiza el catálogo con los juegos filtrados
            }
        } catch (error) {
            console.error("Error al aplicar el filtro:", error);
        }
    } else {
        console.log("No hay géneros seleccionados.");
    }
});

// Actualizar los filtros aplicados y mostrar/ocultar el botón de borrar filtros
function actualizarFiltrosAplicados() {
    const contenedorFiltros = document.getElementById('lista-filtros');
    const botonBorrarFiltros = document.getElementById('borrar-filtros');

    if (generosSeleccionados.length > 0) {
        contenedorFiltros.textContent = generosSeleccionados.join(', ');
        botonBorrarFiltros.style.display = 'inline-block'; // Mostrar el botón
    } else {
        contenedorFiltros.textContent = 'Ninguno';
        botonBorrarFiltros.style.display = 'none'; // Ocultar el botón
    }
}

// Restablecer filtros al hacer clic en "Borrar filtros"
document.getElementById('borrar-filtros').addEventListener('click', async () => {
    generosSeleccionados = []; // Vaciar los filtros seleccionados
    actualizarFiltrosAplicados(); // Actualizar la lista de filtros aplicados

    // Restablecer el catálogo a todos los juegos
    try {
        const response = await fetch('/juegos'); // Supón que esta ruta devuelve todos los juegos
        if (response.ok) {
            const juegos = await response.json();
            mostrarJuegosFiltrados(juegos); // Actualiza el catálogo con todos los juegos
        } else {
            console.error("Error al cargar todos los juegos:", response.statusText);
        }
    } catch (error) {
        console.error("Error al cargar todos los juegos:", error);
    }
});


    function addToLibrary(button) {
        const gameId = button.getAttribute('data-id'); // Obtén el ID del juego
        const token = button.getAttribute('data-token'); // Obtén el token desde el atributo data-token

        if (!token) {
            alert("No estás autenticado. Por favor, inicia sesión.");
            return;
        }

        fetch(`/biblioteca/${gameId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}` // Incluye el token en el encabezado
            },
        })
            .then(response => {
                if (response.ok) {
                    alert("El juego ha sido agregado a tu biblioteca!");
                } else {
                    alert("No se pudo agregar el juego a la biblioteca. Por favor, verifica tu sesión.");
                }
            })
            .catch(error => {
                console.error("Error al agregar el juego a la biblioteca:", error);
            });
    }

    function toggleMenu() {
        const submenu = document.querySelector('.submenu-usuario');
        submenu.classList.toggle('mostrar');
    }
</script>
</body>

</html>
